---
title: "Make Convenient Inputs for Gavi MenA Models"
author: "Chris Stewart"
date: "November 21, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

Let's take a directory as input and look for the files containing the strings cbr, cdr, imr, 
  tot_pop & qq_pop
Also input: country
1) country_params file
Variables I have: obs, country, year, gender, totalpop,	births,	birthrate,	age_from,	age_to,	imr,	v
v=death rate
births=totalpop*birthrate
gender=always both
age_from and age_to are empty

Inputs: data directory, country (3-letter code), start & end of model
Demographic file assumptions: 
1) filenames contain: tot_pop_both/cbr_both/cdr_both/imr_both
2) only one file matches that (but taking the first if multiple)
3) file structures assumed to be as in 201710gavi v5:
  country_code_numeric-country_code-country-age_from-age_to-year-gender-value
  although minimum required is:
  country_code-country-year-gender-value

Meningitis belt:
BFA,CAF,CMR,ERI,ETH,GHA,GIN,GMB,GNB,KEN,MLI,NER,NGA,SDN,SEN,SSD,TCD,UGA

DO WE NEED TOTAL POP FOR EVERY YEAR OR JUST INITIAL?  YES WE NEED TO CALCULATE BIRTHS
### MAYBE STEP 1 is to validate country against files
read files
```{r}
library(dplyr)
library(lubridate)

setwd("\\\\HOME/stewcc1/MenAModel/R_programming")
source("ModelInputUtilities.R")
path<-"\\\\HOME/stewcc1/MenAModel/download_test1"
  
countryvec<-c("BFA","CAF","CMR","ERI","ETH","GHA","GIN","GMB","GNB","KEN","MLI","NER","NGA","SDN","SEN","SSD","TCD","UGA")
for (i in 1:length(countryvec)) {
  country_params<-GetDemographicParameters(directory=path, mycountry=countryvec[[i]], start = as.Date("2001-01-01"), end=as.Date("2100-12-31"), fillThreshold=1) 
  test<-country_params[country_params$year==2015,]
  message<-paste("The population of", test$country, "in", test$year, "was", test$totalpop)
  print(message)
}
```
Notes:  does give an error for nonsensical country, butin Fill-in function.
Just 5 countries in test touchstone, give error


PopInputAgeDist: Model will only need start year
```{r }
distvec<-c(countryvec, "XXX")
for (i in 1:length(distvec)) {
  agevec<-GetPopAgeDist(mycountry=distvec[[i]], start=as.Date("2001-01-01"), directory=path)
  return<-paste(distvec[[i]], "(0-4):", agevec[1])
  print(return)
}
#return the vector agedist$fraction
```

VaxCover data:
country-year-DosesCampaign-CoverRoutine-AgeLimCampaign

Source files: routine contains everything
coverage_201710gavi-5_mena-routine-gavi
coverage_201710gavi-5_mena-campaign-gavi
scenario	set_name	vaccine	gavi_support	activity_type	country_code	country	year	age_first	age_last	age_range_verbatim	target	coverage

```{r }
vaccavail<-c(countryvec, "BDI","BEN","CIV","COG","MRT","RWA","TGO","TZA")
for (j in 1:length(vaccavail)) {
  myvacc<-GetVaccScenario(mycountry=vaccavail[[j]], scenario="routine", directory=path)
  msg<-paste (vaccavail[[j]], "has", nrow(myvacc), "rows.")
  print(msg)
  }
```
Notes: GetVaccScenario does not fail if given country not included, just returns 0 rows.
Get a NA coercion warning though regardless.


Touchstone testing:
201708test-1_unwpp_2017_1_qq_pop_both.csv has no records
write a csv
```{r }

```

